#!/usr/bin/env bash

set -e      # Exit immediately if any command fails
set -u      # Using undefined variables is an error. Exit immediately

# Utilities
# ---------

die()      { echo -e "FATAL:" "$@" >&2 ; exit 1 ; }

pretty_diff() {
    git --no-pager diff --no-index "$@"
}

# Environment Setup
# -----------------

run_env() {
    base_dir="$(cd $(dirname $0)/.. && pwd -P)"
    build_dir="$base_dir/.build"
}

# Runners
# -------

run_krun() {
    local driver=$1   ; shift
    local run_file=$1 ; shift
    export K_OPTS=-Xss500m
    krun --directory "$build_dir/$driver/" "$run_file" "$@"
}

run_kprove() {
    local driver="$1"     ; shift
    local proof_file="$1" ; shift
    local init_file="$1"  ; shift
    [[ -f "$proof_file" ]] || die "$proof_file does not exist"
    [[ -f "$init_file"  ]] || die "$init_file does not exist"
    export K_OPTS=-Xmx2G
    ( krun --directory $(build_dir)/$driver --z3-executable "$init_file" --prove "$proof_file" "$@" )
}

run_kdebug() {
    local driver="$1"     ; shift
    local debug_file="$1" ; shift
    ( run_krun "$driver" "$debug_file" --debugger "$@" )
}

# Main
# ----

run_env

# main functionality
run_command="$1" ; shift
case "$run_command" in

    # Running
    run)   run_krun   "$@" ;;
    debug) run_kdebug "$@" ;;
    prove) run_kprove "$@" ;;

    *) echo "
    usage: $0 [run|debug|prove] <driver> <file> <K args>*

       # Running
       # -------
       $0 run   <driver> <pgm>          Run a single PLC program
       $0 debug <driver> <pgm>          Run a single PLC program in the debugger
       $0 prove <driver> <spec> <pgm>   Attempt to prove claim over PLC program

       Note: <pgm> is a path to a file containing a PLC program.
             <spec> is a K reachability claim file.
             <driver> is one of [erc20|execution|translation|typing]

       Note: This command is more for devs and CI servers.
" ; exit ;;
esac
